vaccination:
  title: Vaccination Number Scraper
  description: Published Vaccination Number Scraper
  environment:
    DEBUG: true
  pipeline:
    -
      run: load
      parameters:
        from: "data/de-population-current.csv"
        name: de-population-current
    -
      run: update_resource
      parameters:
        resources: ["de-population-current"]
        metadata:
          path: "data/de-population-current.csv"
    -
      run: load
      parameters:
        from: "https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Daten/Impfquotenmonitoring.xlsx?__blob=publicationFile"
        name: 'de-vaccinations-current'
        format: xlsx
        sheet: 2
        skip_rows:
          -
            type: preset
            value: blank
          - "*"
          - "Anmerkung"
    -
      run: update_resource
      parameters:
        resources: ["de-vaccinations-current"]
        metadata:
          path: 'data/de-vaccinations-current.csv'
    -
      run: add_computed_field
      parameters:
        resources: ["de-vaccinations-current"]
        fields:
          -
            target: "geo"
            operation: format
            with: "{Bundesland}"
          -
            target: "iso-cc"
            operation: constant
            with: "DE"
    -
      run: find_replace
      parameters:
        resources: de-vaccinations-current
        fields:
          -
            name: geo
            patterns:
              -
                find: (\*)
                replace: ''
              -
                find: (Gesamt)
                replace: 'Germany'
    -
      flow: flows.insert_geotype
      parameters:
        resources: ["de-vaccinations-current"]
    -
      run: delete_fields
      parameters:
        resources: de-vaccinations-current
        fields:
          - Bundesland
          - Impfungen pro 1.000 Einwohner
    -
      run: unpivot
      parameters:
        resources: de-vaccinations-current
        extraKeyFields:
          -
            name: key
            type: string
        extraValueField:
          name: value
          type: number
        unpivot:
          -
            name: "Impfungen kumulativ"
            keys:
              key: "sum"
          -
            name: "Differenz zum Vortag"
            keys:
              key: "delta_vortag"
          -
            name: "Indikation nach Alter\\*"
            keys:
              key: "ind_alter"
          -
            name: "Berufliche Indikation\\*"
            keys:
              key: "ind_prof"
          -
            name: "Medizinische Indikation\\*"
            keys:
              key: "ind_med"
          -
            name: "Pflegeheim-bewohnerIn\\*"
            keys:
              key: "ind_pflege"
    - 
      flow: flows.update_resource_date
      parameters:
        resources: ["de-vaccinations-current"]
    -
      run: join
      parameters:
        source: 
          name: de-population-current
          key: ["geo"]
        target: 
          name: de-vaccinations-current
          key: ["geo"]
        fields:
          population:
            name: "population"
        full: true
    -
      flow: flows.quote
      parameters:
        resources: de-vaccinations-current
    -
      run: dump_to_path
      parameters:
        counters:
          datapackage-rowcount: null
          datapackage-bytes: null
          datapackage-hash: null
          resource-rowcount: null
          resource-bytes: null
          resource-hash: null

vaccination-archive:
  title: Vaccination Aggregation
  description: Archive Published Vaccination Number Scraper
  dependencies:
    -
      pipeline: ./vaccination
  environment:
    DEBUG: true
  pipeline:
    # - 
    #   run: load
    #   parameters:
    #     from: datapackage.json
    -
      run: update_package
      parameters:
        name: 'covid19-vaccinations-germany'
        title: 'COVID-19 Vaccination Rates in Germany'
        homepage: 'https://github.com/n0rdlicht/rki-vaccination-scraper'
        keywords:
          - "COVID-19"
          - "RKI"
          - "Germany"
          - "Vaccination"
        sources: 
          -
            title: "RKI Digitales Impfquotenmonitoring"
            path: 'https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Daten/Impfquoten-Tab.html'
        contributors:
          -
            title: "Thorben Westerhuys"
            role: "maintainer"
            path: "https://github.com/n0rdlicht"
        license: "ODC-PDDL-1.0"
        licenses:
          -
            name: "ODC-PDDL-1.0"
            path: "http://opendatacommons.org/licenses/pddl/"
            title: "Open Data Commons Public Domain Dedication and License v1.0"
    -
      run: load
      parameters:
        from: "data/de-population-current.csv"
        name: de-population-current
    -
      run: update_resource
      parameters:
        resources: ["de-population-current"]
        metadata:
          path: "data/de-population-current.csv"
          last_update: "2019-12-31"
          last_published: "2020-06-19"
    -
      run: load
      parameters:
        from: "data/de-vaccinations-current.csv"
        name: 'de-vaccinations-current'
    -
      run: update_resource
      parameters:
        resources: ["de-vaccinations-current"]
        metadata:
          path: 'data/de-vaccinations-current.csv'
    - 
      flow: flows.update_resource_date
      parameters:
        resources: ["de-vaccinations-current"]
    -
      run: load
      parameters:
        from: "data/de-vaccinations.csv"
        name: 'de-vaccinations'
    -
      run: update_resource
      parameters:
        resources: ["de-vaccinations"]
        metadata:
          path: 'data/de-vaccinations.csv'
    - 
      flow: flows.update_resource_date
      parameters:
        resources: ["de-vaccinations"]
    -
      run: duplicate
      parameters:
        source: "de-vaccinations-current"
        target-name: "de-vaccinations-current-dated"
        target-path: "data/de-vaccinations-current-dated.csv"
    -
      flow: flows.insert_date
      parameters:
        resources: "de-vaccinations-current-dated"
    -
      run: concatenate
      parameters:
        sources: ["de-vaccinations","de-vaccinations-current-dated"]
        target:
          name: de-vaccinations
          path: data/de-vaccinations.csv
        fields:
          date: []
          geo: []
          geotype: []
          iso-cc: []
          key: []
          value: []
          population: []
          quote: []
    -
      flow: flows.set_primary_key
      parameters:
        resources: ["de-vaccinations"]
        primary-key: ["date","geo","key"]
    -
      run: deduplicate
      parameters:
        resources: de-vaccinations
    -
      run: sort
      parameters:
        resources: de-vaccinations
        sort-by: "{date}"
    # -
    #   run: join
    #   parameters:
    #     source: 
    #       name: de-vaccinations
    #       key: ["date","geo","key"]
    #       delete: True
    #     target: 
    #       name: de-vaccinations
    #       key: null
    #     fields:
    #       date:
    #         name: date
    #       geo:
    #         name: geo
    #       iso-cc:
    #         name: iso-cc
    #       geotype:
    #         name: geotype
    #       key:
    #         name: key
    #       value:
    #         name: value
    #       population:
    #         name: population
    #       quote:
    #         name: quote
    -
      run: dump_to_path
      parameters:
        counters:
          datapackage-rowcount: null
          datapackage-bytes: null
          datapackage-hash: null
          resource-rowcount: null
          resource-bytes: null
          resource-hash: null